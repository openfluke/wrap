<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Paragon WASM CPU vs WebGPU Demo</title>
    <script src="wasm_exec.js"></script>
  </head>
  <body>
    <h1>Paragon WASM CPU vs WebGPU</h1>

    <button onclick="runComparison()">Run CPU + GPU Comparison</button>

    <pre id="output"></pre>

    <script>
      const go = new Go();
      let network = null;

      async function loadWasm() {
        const result = await WebAssembly.instantiateStreaming(
          fetch("paragon.wasm"),
          go.importObject
        );
        go.run(result.instance);
      }

      async function runComparison() {
        const output = document.getElementById("output");
        output.textContent = "Running comparison...";

        const layerSizes = JSON.stringify([
          { Width: 32, Height: 32 }, // 1024
          { Width: 16, Height: 32 }, // 512
          { Width: 16, Height: 16 }, // 256
          { Width: 32, Height: 32 }, // 128
          { Width: 8, Height: 8 }, // 64
          { Width: 1, Height: 10 }, // 10
        ]);

        const activations = JSON.stringify([
          "leaky_relu",
          "leaky_relu",
          "leaky_relu",
          "leaky_relu",
          "leaky_relu",
          "softmax",
        ]);

        const fullConnect = JSON.stringify([
          true,
          true,
          true,
          true,
          true,
          true,
        ]);

        const input = JSON.stringify([
          [...Array(1024)].map(() => Math.random()),
        ]);

        network = NewNetworkFloat32(layerSizes, activations, fullConnect);

        // Run on CPU
        const cpuStart = performance.now();
        network.Forward(input);
        const cpuOutput = network.GetOutput("[]");
        const cpuEnd = performance.now();

        // Enable GPU
        const initResult = network.InitializeOptimizedGPU("[float32]");
        if (initResult && initResult.startsWith("Failed")) {
          output.textContent = `WebGPU init failed: ${initResult}`;
          return;
        }

        // Run on GPU
        const gpuStart = performance.now();
        network.Forward(input);
        const gpuOutput = network.GetOutput("[]");
        const gpuEnd = performance.now();

        const cpuValues = JSON.parse(cpuOutput)[0]
          .map((n) => n.toFixed(4))
          .join(", ");
        const gpuValues = JSON.parse(gpuOutput)[0]
          .map((n) => n.toFixed(4))
          .join(", ");

        output.textContent = `
âœ… CPU Time: ${(cpuEnd - cpuStart).toFixed(2)} ms
ðŸ§  CPU Output: [${cpuValues}]

ðŸš€ GPU Time: ${(gpuEnd - gpuStart).toFixed(2)} ms
âš¡ GPU Output: [${gpuValues}]
        `.trim();
      }

      loadWasm().catch(console.error);
    </script>
  </body>
</html>
